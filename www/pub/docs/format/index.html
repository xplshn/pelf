<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="manifest" href="/pelf/site.webmanifest">
  <meta name="apple-mobile-web-app-title" content="AppBundle Documentation &amp; Implementation Details">
  <meta name="application-name" content="AppBundle Documentation &amp; Implementation Details">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="theme-color" content="#ffffff">

  <style>
    body{font-family:monospace;}
    html{cursor: url('https://xplshn.github.io/img/9cursor.png'), auto;}
  </style>

  <title>format.md</title>
  
  
  <link rel="stylesheet" href="https://xplshn.github.io/pelf/css/style.css">
  
  <link rel="stylesheet" href="https://xplshn.github.io/pelf/css/theme_blue.css">

  

  
  <link href='https://xplshn.github.io/css/SerenityOS-Emoji.css' rel="stylesheet" type="text/css">
  <link href='https://xplshn.github.io/css/highlightjs_style.css' rel="stylesheet" type="text/css">
  
  <script src="https://xplshn.github.io/js/tex-mml-svg.js"></script>
  <script src="https://xplshn.github.io/js/highlight.min.js"></script>
  <script src="https://xplshn.github.io/js/highlight-basic.min.js"></script>
  <script src="https://xplshn.github.io/js/highlight-bash.min.js"></script>
  <script src="https://xplshn.github.io/js/highlight-go.min.js"></script>
  <script src="https://xplshn.github.io/js/highlight-c.min.js"></script>
  
  <script>
  (function() {
    function center_el(tagName) {
      var tags = document.getElementsByTagName(tagName), i, tag;
      for (i = 0; i < tags.length; i++) {
        tag = tags[i];
        var parent = tag.parentElement;
        
        if (parent.childNodes.length === 1) {
          
          if (parent.nodeName === 'A') {
            parent = parent.parentElement;
            if (parent.childNodes.length != 1) continue;
          }
          if (parent.nodeName === 'P') parent.style.textAlign = 'center';
        }
      }
    }
    var tagNames = ['img', 'embed', 'object'];
    for (var i = 0; i < tagNames.length; i++) {
      center_el(tagNames[i]);
    }
  })();
  </script>

  
  
  
  
  
  
  
  

</head>
<body>
  <header>
    <nav class="no-print">
    
    <div class="left">
      
    </div>
    <div class="right">
      <span class="doNotDisplay">Related sites:</span>
      |
      
        <a href="https://musl.libc.org">musl.libc.org</a> |
      
        <a href="https://web.archive.org/web/20231123031907/https://managainstthestate.blogspot.com/2011/08/anarcho-capitalist-resources-by-wesker.html">managainstthestate.blogspot.com</a> |
      
        <a href="https://shithub.us">shithub.us</a> |
      
        <a href="https://copacabana.pindorama.net.br">copacabana.pindorama.net.br</a> |
      
        <a href="https://suckless.org">suckless.org</a> |
      
        <a href="https://nosystemd.org">nosystemd.org</a> |
      
        <a href="https://harmful.cat-v.org">harmful.cat-v.org</a> |
      
        <a href="https://github.com/xplshn/dbin">dbin</a> |
      
        <a href="https://fatbuffalo.neocities.org/def">neoblog</a> |
      
        <a href="/pelf/index.xml">subscribe</a> |
      
    </div>
  </nav>
  <h1>
    <a href="https://xplshn.github.io/pelf/">AppBundle Documentation &amp; Implementation Details
      <span id="headerSubTitle">Labs</span>
    </a>
  </h1>
</header>

  
<nav id="side-bar" class="no-print">
<style>@media print {article {display: block;margin-left: auto;margin-right: auto;width: 100%;}}</style>

  <div>
    <ul>
    
    
      
        <li><a href="/pelf/" title="">&rsaquo; Home</a></li>
      
    
    
    
      
        <li><a href="https://xplshn.github.io/pelf/docs/" title="Documentation Index">&rsaquo; Documentation Index</a></li>
      
    
    </ul>
  </div>
</nav>


  <article id="main">
    
  <div class="article-meta">
    <h1><span class="title">format.md</span></h1>
    
        <span class="author">
    <span class="author">
      by
      <a href="mailto:xplshn@murena.io">
        xplshn
      </a>
    </span>

</span>
        
            &ndash; <span class="date">2025/05/25</span>
        
    
    <p class="terms">
      
        
      
        
      
    </p>
  </div>
  
  <main>
    <h1 id="appbundle-file-format-specification">AppBundle File Format Specification</h1>
<p>This document outlines the structure and composition of an AppBundle, a self-contained executable format designed to package applications with their dependencies for portable execution on Linux systems.</p>
<h2 id="file-structure">File Structure</h2>
<p>An AppBundle is a single executable file that combines an ELF (Executable and Linkable Format) runtime with an appended filesystem image containing the application&rsquo;s data. The structure is as follows:</p>
<ol>
<li>
<p><strong>ELF Runtime</strong>:</p>
<ul>
<li>The AppBundle begins with an ELF executable, identifiable by the magic bytes &ldquo;AB&rdquo; or optionally &ldquo;AI&rdquo; at the start of the file.</li>
<li>This runtime is responsible for handling the execution logic, including mounting or extracting the filesystem image and setting up the environment.</li>
</ul>
</li>
<li>
<p><strong>Runtime Information Section (.pbundle_runtime_info)</strong>:</p>
<ul>
<li>The ELF file contains a section named <code>.pbundle_runtime_info</code>, which stores metadata in CBOR (Concise Binary Object Representation) format.</li>
<li>The structure of this section is defined in Go as:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RuntimeInfo</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">AppBundleID</span>          <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;AppBundleID&#34;`</span> <span style="color:#75715e">// Unique identifier for the AppBundle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">PelfVersion</span>          <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;PelfVersion&#34;`</span> <span style="color:#75715e">// Version of the pelf tool used to create the AppBundle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">HostInfo</span>             <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;HostInfo&#34;`</span> <span style="color:#75715e">// System information from `uname -mrsp(v)`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">FilesystemType</span>       <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;FilesystemType&#34;`</span> <span style="color:#75715e">// Filesystem type: &#34;dwarfs&#34; or &#34;squashfs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Hash</span>                 <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;Hash&#34;`</span> <span style="color:#75715e">// Hash of the filesystem image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">DisableRandomWorkDir</span> <span style="color:#66d9ef">bool</span>   <span style="color:#e6db74">`json:&#34;DisableRandomWorkDir&#34;`</span> <span style="color:#75715e">// Whether to use a fixed working directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">MountOrExtract</span>       <span style="color:#66d9ef">uint8</span>  <span style="color:#e6db74">`json:&#34;MountOrExtract&#34;`</span> <span style="color:#75715e">// Run behavior: 0 (FUSE only), 1 (Extract only), 2 (FUSE with extract fallback), 3 (FUSE with extract fallback for files &lt; 350MB)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Static Tools Section (.pbundle_static_tools)</strong>:</p>
<ul>
<li>The ELF file includes a section named <code>.pbundle_static_tools</code>, containing a Zstandard (ZSTD)-compressed tar archive.</li>
<li>This archive holds tools necessary for mounting or extracting the filesystem image, such as <code>dwarfs</code>, <code>dwarfsextract</code>, <code>squashfuse</code>, or <code>unsquashfs</code>, depending on the filesystem type.</li>
</ul>
</li>
<li>
<p><strong>Filesystem Image</strong>:</p>
<ul>
<li>Immediately following the ELF runtime, the AppBundle contains the compressed filesystem image (either DwarFS or SquashFS).</li>
<li>This image encapsulates the application&rsquo;s AppDir, including all necessary files and dependencies.</li>
</ul>
</li>
</ol>
<h2 id="creation-of-an-appbundle">Creation of an AppBundle</h2>
<p>An AppBundle is created using the <code>pelf</code> tool, which performs the following steps:</p>
<ol>
<li>
<p><strong>Prepare the AppDir</strong>:</p>
<ul>
<li>The <code>pelfCreator</code> tool constructs an AppDir, a directory containing the application&rsquo;s files, including:
<ul>
<li><code>AppRun</code>: The entrypoint script that orchestrates the execution.</li>
<li><code>.DirIcon</code>: An optional icon file (PNG, in sizes 512x512, 256x256, or 128x128).</li>
<li><code>.DirIcon.svg</code>: An optional SVG icon.</li>
<li><code>program.desktop</code>: An optional desktop entry file.</li>
<li><code>program.appdata.xml</code>: An optional AppStream metadata file.</li>
<li><code>proto</code> or <code>rootfs</code>: A directory containing the application&rsquo;s filesystem, typically based on a minimal Linux distribution like Alpine or ArchLinux.</li>
</ul>
</li>
<li>The AppDir may also include additional binaries and configuration files as needed.</li>
</ul>
</li>
<li>
<p><strong>Embed Runtime Information</strong>:</p>
<ul>
<li>The <code>pelf</code> tool embeds the <code>.pbundle_runtime_info</code> section with metadata about the AppBundle, including its ID, filesystem type, and runtime behavior.</li>
</ul>
</li>
<li>
<p><strong>Embed Static Tools</strong>:</p>
<ul>
<li>Tools required for mounting or extracting the filesystem (e.g., <code>dwarfs</code>, <code>squashfuse</code>) are compressed into a ZSTD tar archive and embedded in the <code>.pbundle_static_tools</code> section.</li>
</ul>
</li>
<li>
<p><strong>Append Filesystem Image</strong>:</p>
<ul>
<li>The AppDir is compressed into a DwarFS or SquashFS image, depending on the configuration, and appended to the ELF runtime.</li>
<li>The offset of the filesystem image is recorded in the runtime configuration for access during execution.</li>
</ul>
</li>
<li>
<p><strong>Finalize the Executable</strong>:</p>
<ul>
<li>The <code>pelf</code> tool combines the ELF runtime, runtime information, static tools, and filesystem image into a single executable file with the <code>.AppBundle</code> extension.</li>
</ul>
</li>
</ol>
<h2 id="run-behaviors">Run Behaviors</h2>
<p>The <code>MountOrExtract</code> field in the <code>.pbundle_runtime_info</code> section determines how the AppBundle behaves when executed:</p>
<ul>
<li><strong>0 (FUSE Mounting Only)</strong>: The AppBundle uses FUSE to mount the filesystem image. If FUSE is unavailable, it fails without falling back to extraction.</li>
<li><strong>1 (Extract and Run)</strong>: The AppBundle extracts the filesystem image to a temporary directory (typically in <code>tmpfs</code>) and executes from there, ignoring FUSE even if available.</li>
<li><strong>2 (FUSE with Fallback)</strong>: The AppBundle attempts to use FUSE to mount the filesystem. If FUSE is unavailable, it falls back to extracting the filesystem to <code>tmpfs</code>.</li>
<li><strong>3 (FUSE with Conditional Fallback)</strong>: Similar to option 2, but fallback to extraction only occurs if the AppBundle file is smaller than 350MB.</li>
</ul>
<h2 id="expected-contents-of-the-filesystem-image">Expected Contents of the Filesystem Image</h2>
<p>The filesystem image within the AppBundle is expected to be an AppDir with at least the following:</p>
<ul>
<li><strong>AppRun</strong>: A shell script that serves as the entrypoint for the application. It sets up the environment and executes the main program.</li>
<li><strong>Optional Files</strong>:
<ul>
<li><code>.DirIcon</code>: A PNG icon in a standard size (512x512, 256x256, or 128x128).</li>
<li><code>.DirIcon.svg</code>: An SVG icon</li>
<li><code>program.desktop</code>: A desktop entry file for integration with desktop environments.</li>
<li><code>program.appdata.xml</code>: An AppStream metadata file for application metadata.</li>
<li><code>proto</code> or <code>rootfs</code>: A directory containing the application&rsquo;s filesystem, including binaries, libraries, and configuration files.</li>
</ul>
</li>
</ul>
<h2 id="notes">Notes</h2>
<ul>
<li>The AppBundle format is designed to be self-contained, requiring no external dependencies for execution in most cases, assuming the necessary tools are embedded or available on the host system.</li>
<li>The choice of filesystem (DwarFS or SquashFS) affects the tools included in the <code>.pbundle_static_tools</code> section and the runtime behavior.</li>
</ul>

  </main>

  </article>
  <footer class="no-print">
    <div class="pull-left">
        <a href="https://gohugo.io">Powered by Hugo.</a>
    </div>
    
    </div>
</footer>


  
  
  
  
  
  
</body>
</html>
